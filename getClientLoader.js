var util = require('util');

/**
 * Main function houses contents of CLoader closure and serializes whole function,
 * binding various config params in the process.
 *
 * Object itself resides under var f
 *
 *
 * @param exchangeHostname
 * @param exchangeSecureHostname
 * @param pubPath
 * @returns {*}
 */
module.exports = function(exchangeHostname, exchangeSecureHostname, pubPath){
    var f = function(){
        var IMAGE_ATTR = 'data-cliquesnative';

        var _copyAttributes = function(oldNode, newNode){
            for (var i=0; i < oldNode.attributes.length; i++){
                var attr = oldNode.attributes[i];
                newNode.setAttribute(attr.name, attr.value);
            }
        };

        var _replaceTemplateVar = function(template, varName, value){
            var re = new RegExp('{{(\\s|)' + varName + '(\\s|)}}','g');
            return template.replace(re, value);
        };

        var _addAttributeToTemplateVarElement = function(template, varName, attributeTitle){
            var re = new RegExp('({{[\\s|]' + varName + '[\\s|]}}.*?)(>)','g');
            return template.replace(re, '$1 ' + attributeTitle + '$2');
        };

        var _findChildWithAttribute = function(element, attribute){
            var c;
            var _inner = function(element, attribute){
                if (element.childElementCount){
                    for (var i=0; i<element.children.length; i++){
                        var child = element.children[i];
                        if (child.hasAttribute(attribute)){
                            c = child;
                        } else {
                            _inner(child, attribute);
                        }
                    }
                }
            };
            _inner(element, attribute);
            return c;
        };

        var _getTransformUrlFromCanonical = function(canonicalUrl, width, height){
            var transform = 'c_thumb,g_auto,h_' + height + ',w_' + width;
            return canonicalUrl.replace(/(image\/upload\/)(.*$)/g,"$1" + transform + "/$2");
        };

        /**
         * Post-render steps for native ads. Primary purpose is to determine the size
         * that the image needs to be based on DOM introspection, and then call the appropriate
         * transform URL & replace image source as necessary within native template.
         *
         * @param targetElement
         * @param context
         * @param dims
         * @private
         */
        var _templatePostRender = function(targetElement, context, dims){

            // first, un-wrap element and re-insert template where <ins> was
            // this shouldn't re-render any remote sources, just move the DOM elements into the right placeholder
            var parent = targetElement.parentElement;
            var newTargets = [];
            var childrenLength = targetElement.children.length;
            for (var j=0; j< childrenLength; j++){
                // node.insertBefore pops the element from the children array,
                // so just push the 0th element for each j
                newTargets.push(parent.insertBefore(targetElement.children[0], targetElement));
            }
            parent.removeChild(targetElement);

            // find image element and set source to native image
            // check all elements that were added to DOM
            var image;
            for (var i=0; i < newTargets.length; i++){
                image = _findChildWithAttribute(newTargets[i], 'data-cliquesnative');
                if (image){
                    break;
                }
            }
            if (!image){
                console.error('Error: no image template tag found in template.');
                return;
            }

            if (!dims) {
                // this is a 2000x2000px blank PNG image.
                var img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB9AAAAfQCAYAAACaOMR5AAABG2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+Gkqr6gAAAYFpQ0NQc1JHQiBJRUM2MTk2Ni0yLjEAACiRdZHfK4NRGMc/NouYKBTlYmlcjYZauFAmjVrSTBluttd+qP14e98tLbfKraLEjV8X/AXcKtdKESkpd66JG9brebfVJHtOz3k+53vO83TOc8ASTCopvdYNqXRWC/i8joXQoqPuBRudtDOKM6zo6vjsrJ+q9nlPjRlv+8xa1c/9a40rUV2BmnrhMUXVssJTwv61rGryjnCbkgivCJ8JuzS5oPCdqUdK/GpyvMTfJmvBwARYWoQd8V8c+cVKQksJy8txppI5pXwf8yX2aHp+TmK3eBc6AXx4cTDNJBN4GGBEZg99DNIvK6rku4v5M2QkV5FZJY/GKnESZHGJmpPqUYkx0aMykuTN/v/tqx4bGixVt3vB9mwY7z1Qtw2FLcP4OjKMwjFYn+AyXcnPHMLwh+hbFc15AM0bcH5V0SK7cLEJHY9qWAsXJau4JRaDt1NoCkHrDTQslXpW3ufkAYLr8lXXsLcPvXK+efkHq8ZoBWU5G84AAAAJcEhZcwAACxMAAAsTAQCanBgAACAASURBVHic7MEBAQAAAICQ/q/uCAoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIDZgwMBAAAAACD/10ZQVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVJuz5TQAAHM5JREFUVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVYQ8OBAAAAACA/F8bQVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVaU9OCQAAAAAEPT/tSOsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwBU6HAABVjIW1QAAAABJRU5ErkJggg==';
                if (image) image.src = img;
            }
            window.setTimeout(function(){
                var h = dims ? dims.height: image.clientHeight;
                var w = dims ? dims.width: image.clientWidth;
                if (context.minImageHeight){
                    h = Math.max(h, context.minImageHeight);
                }
                if (context.minImageWidth){
                    w = Math.max(w, context.minImageWidth);
                }
                image.src = _getTransformUrlFromCanonical(context.secureImageUrl, w, h);
            });
        };

        /**
         * Script tags written to DOM (i.e. passback tags) will not execute, so this
         * function re-inserts all script tags within a given element so they can be
         * properly executed.
         *
         * @param parent
         * @private
         */
        var _replaceScripts = function(parent){
            for (var j=0; j < parent.children.length; j++){
                var thisNode = parent.children[j];
                if (thisNode.nodeName === 'SCRIPT'){
                    if (thisNode.attributes.src){
                        var nextSibling = thisNode.nextSibling;
                        parent.removeChild(thisNode);
                        // now create new element
                        var new_s = document.createElement("script");
                        _copyAttributes(thisNode, new_s);
                        parent.insertBefore(new_s, nextSibling);
                    } else {
                        (new Function(thisNode.innerText))();
                    }
                }
                if (thisNode.children.length > 0){
                    _replaceScripts(thisNode);
                }
            }
        };

        /**
         * Helper function to check browser userAgent string and determine if browser is mobile browser or not
         * based on regex. Regex should be updated periodically.
         *
         * Regex was copied from open source scripts available at [http://detectmobilebrowsers.com/]
         *
         * @returns {boolean}
         */
        var _isMobile = function(){
            var check = false;
            (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
            return check;
        };

        var _Loader = function(options){
            // to be populated by build scripts & outer constructors
            this.exchange_hostname = '%s';
            this.exchange_secure_hostname = '%s';
            this.pub_path = '%s';

            // basic options
            this.pid = options.pid;
            this.secure = options.secure;
            this.type = options.type || 'display';
            this.debug = options.debug;

            // determine formFactor right upfront
            this.formFactor = _isMobile() ? 'mobile' : 'desktop';

            // deeper template options, including placeholder objects for native & display specifics
            this.native = {};
            this.display = {};
            this.multiPaneNative = {};

            this.keywords = options.keywords || false;

            // if targetId && targetChildIndex are set, will override 'lazy' flag behavior,
            // i.e. main() will render ad in target elements.
            this.targetId = options.targetId;
            this.targetChildIndex = options.targetChildIndex;

            // Form ad exchange URL
            var u = (this.secure ? 'https://' + this.exchange_secure_hostname : 'http://' + this.exchange_hostname);
            u += this.pub_path;
            u += '?' + 'pid=' + this.pid + '&type=javascript&form-factor=' + this.formFactor;
            // add keywords to URL if available
            if (this.keywords) {
                var keywords = this.parseKeywords(this.keywords);
                // keywords being null means error has been thrown, so don't append to URL;
                if (keywords) u += '&keywords=' + keywords;
            }
            // add debug parameter if true, which will tell exchange to send
            // back additional debugging data along with response.
            if (this.debug){
                u += '&debug=true';
            }
            this.url = encodeURI(u);

            // For fixed aspectRatio images. If not specified, will deduce dimensions from rendered h & w of image
            // element
            if (options.aspectHeight && options.aspectWidth){
                this.native.aspectRatio = {};
                this.native.aspectRatio.height = options.aspectHeight;
                this.native.aspectRatio.width = options.aspectWidth;
                // either landscape or portait
                this.native.aspectRatio.layout = options.aspectLayout || 'landscape';
                // factor to multiply aspect ratio H*W by when calling image
                this.native.aspectRatio.scaleFactor = options.scaleFactor || 500;
            } else if (options.aspectHeight || options.aspectWidth){
                console.warn('To use a fixed aspect ratio, you must provide both `aspectHeight` and `aspectWidth` options.')
            }
            // Set to 'true' if goal is to just get raw HTML from tag.
            // if 'true', will return template HTML from this.main();
            // NOTE: If set to 'true', main() MUST be called w/ callback function
            this.lazy = options.lazy || false;
        };

        /**
         * Users can pass in keywords to options when instantiating CLoader, so need to
         * a) determine what type of keyword value has been passed (string or array of strings)
         * b) catch any parsing errors and warn user without erroring out.
         */
        _Loader.prototype.parseKeywords = function(keywords){
            var warning = 'Could not parse keywords: ' + keywords +
                '. Keywords must be an array of strings or comma-separated values string.';
            var keywordStr;
            if (keywords){
                if (typeof keywords === 'object'){
                    try {
                        keywordStr = keywords.join(',');
                    } catch (e) {
                        console.warn(warning);
                    }
                } else if (typeof keywords === 'string') {
                    keywordStr = keywords;
                } else {
                    console.warn(warning);
                }
            }
            return keywordStr;
        };

        /**
         * Gets width & height of image required based on `this.native.aspectRatio` spec.
         *
         * Currently, this normalizes H & W of aspect ratio based on `aspectRatio.layout`. That is,
         * it respects `aspectRatio.layout` above all else when determining which dimension is truly
         * height & which is truly width. So if `aspectRatio.layout` === 'landscape', width will be
         * the greater of the W:H, and vice-versa for 'portait'.
         *
         * Will work for both single native placements & multiPaneNative placements
         *
         * @returns {{width: (number|*), height: (number|*)}}
         */
        _Loader.prototype.getDimsFromAspectRatio = function(){
            var self = this;
            var layout = self.native.aspectRatio.layout;
            var max = Math.max(self.native.aspectRatio.width,self.native.aspectRatio.height);
            var min = Math.min(self.native.aspectRatio.width,self.native.aspectRatio.height);
            var width, height;
            if (layout === 'landscape'){
                width = max;
                height = min;
            } else if (layout === 'portait'){
                width = min;
                height = max;
            } else {
                console.warn('Accepted aspectLayout values are `landscape` or `portrait`. Cannot deduce ' +
                    'dimensions with layout ' + layout);
                return;
            }
            width = Math.round(self.native.aspectRatio.scaleFactor * width);
            height = Math.round(self.native.aspectRatio.scaleFactor * height);
            return { width: width, height: height };
        };

        /**
         * Finds target DOM node on the page where ad tag is to be inserted.
         *
         * @param insertBefore {Boolean} if `true`, and dynamic insertion is
         *  enabled for this loader, will insert an '<ins>' tag before the n-th child
         *  of the targetId element and return that node. If `false`, will just return
         *  the n-th node.
         * @returns {*}
         */
        _Loader.prototype.findTargetElement = function(insertBefore){
            var self = this;
            var el;
            if (this.targetId && this.targetChildIndex){
                // if both targetId & targetChildIndex are present, then
                // creates an <ins> element as the {{targetChildIndex}}-th child of
                // the element w/ ID {{targetId}}
                var parent = document.getElementById(self.targetId);
                el = parent.children[self.targetChildIndex];
                if (insertBefore){
                    var newNode = document.createElement('ins');
                    el = parent.insertBefore(newNode, el);
                }
            } else {
                // otherwise, expects element with the id 'cloader-{ self.pid }' to accompany this tag
                // & be in the DOM somewhere, and gets that.
                el = document.getElementById('cloader-' + self.pid);
            }
            return el;
        };

        /**
         * Binds template variables in creativeContext to native ad template stored in `placementContext`.
         *
         * Populated all variables according to publisher restrictions (where applicable, i.e. `headline` &
         * `description`) EXCEPT for `secureImageUrl` & `imageUrl`, which get an attribute added to their
         * element as a flag for the post-render step to come back & attach src attributes to.
         *
         * @param template
         * @param context
         * @returns {*}
         */
        _Loader.prototype.renderNativeTemplate = function(template, context){
            var self = this;
            // brandDisclosure is a derived property (from brandDisclosurePrefix and advertiserName)
            // so set it to 'true' so it can get handled in the switch statement below
            context.brandDisclosure = true;
            var trunctedSuffix = '...';
            for (var k in context){
                if (context.hasOwnProperty(k)){
                    var value;
                    // handle special cases that need to get truncated / modified according to publisher specs
                    switch (k){
                        case 'headline':
                            value = context.headlineMaxLength ?
                            context[k].slice(0, context.headlineMaxLength) + trunctedSuffix : context[k];
                            break;
                        case 'description':
                            value = context.descriptionMaxLength ?
                            context[k].slice(0, context.descriptionMaxLength) + trunctedSuffix : context[k];
                            break;
                        case 'brandDisclosure':
                            value = context.brandDisclosurePrefix + " " + context.advertiserName;
                            break;
                        default:
                            value = context[k];
                    }
                    if (k === 'imageUrl' || k === 'secureImageUrl') {
                        if (self.lazy){
                            // if "lazy", then dimensions are assumed to be passed in already
                            // under context.nativeDimensions, so go ahead and get the transformURL
                            var newUrl = _getTransformUrlFromCanonical(context[k],
                                context.nativeDimensions.width,
                                context.nativeDimensions.height);
                            template = _replaceTemplateVar(template,k,newUrl);
                        } else {
                            // otherwise, just add an attribute to the element so that the post-render step
                            // can size it and inject the transform URL.
                            template = _addAttributeToTemplateVarElement(template, k, IMAGE_ATTR);
                        }
                    } else {
                        template = _replaceTemplateVar(template, k, value);
                    }
                }
            }
            // add separate <img> element for impTracker to beginning of the template
            if (context.impTracker){
                template = template + '<img src="' + context.impTracker + '" height="1" width="1" border="0" alt="Advertisement"/>';
            }
            // advertisement disclosure is stored in placementContext, not creativeContext
            if (context.advertisementDisclosure){
                template = _replaceTemplateVar(template, 'advertisementDisclosure', context.advertisementDisclosure);
            }
            return template;
        };

        /**
         * Creates unified context object to pass to template
         */
        _Loader.prototype.getNativeContext = function(placementSpecs, creativeSpecs){
            var context = creativeSpecs;
            // enumerate all of the properties of placement specs
            // and add them to context
            var placementParams = [
                'brandDisclosurePrefix',
                'headlineMaxLength',
                'descriptionMaxLength',
                'advertisementDisclosure',
                'minImageHeight'
            ];
            placementParams.forEach(function(param){
                context[param] = placementSpecs[param];
            });
            return context;
        };

        /**
         *
         * @param lazyCallback only required applicable if this.lazy === true && this.type === 'native'
         * @returns {*}
         */
        _Loader.prototype.doNativeRender = function(lazyCallback){
            var self = this;
            var context = self.getNativeContext(self.native.placementSpecs, self.native.creativeSpecs);
            var template = self.native.placementSpecs.template;

            // fixed dimensions passed to loader
            var dims;
            if (self.native.aspectRatio){
                dims = self.getDimsFromAspectRatio();
                context.imageDimensions = dims;
            }
            // figure out how ad markup should be injected or returned
            if (self.lazy){
                // otherwise, don't perform all post-render steps and just
                // do the last template variable injection before passing
                // HTML as string to callback function
                if (!dims){
                    var err = 'Error: lazy loading requested but no aspectRatio provided. ' +
                        'Can\'t determine desired image dimensions.';
                    return lazyCallback(err);
                }
                return lazyCallback(null, template, context);
            } else {
                var markup = self.renderNativeTemplate(template, context);
                var el = self.findTargetElement(true);
                el.innerHTML = markup;
                _templatePostRender(el, context, dims);
            }
        };

        _Loader.prototype.getPanePlaceholderAttribute = function(index){
            return 'data-cliques-pane-' + index;
        };

        _Loader.prototype.getPanePlaceholder = function(index){
            return '<ins ' + this.getPanePlaceholderAttribute(index) + '></ins>';
        };

        /**
         * Renders a single pane of a multiPaneNative placement
         *
         * @param lazyCallback only required applicable if this.lazy === true && this.type === 'native'
         * @param index
         * @returns {*}
         */
        _Loader.prototype.doMultiPaneNativeRender = function(index, lazyCallback){
            var self = this;
            var context = self.getNativeContext(
                self.multiPaneNative.placementSpecs.pane,
                self.multiPaneNative.creativeSpecs[index]);
            var template = self.multiPaneNative.placementSpecs.pane.template;

            // fixed dimensions passed to loader
            var dims;
            if (self.native.aspectRatio){
                dims = self.getDimsFromAspectRatio();
                context.imageDimensions = dims;
            }
            // figure out how ad markup should be injected or returned
            if (self.lazy){
                // otherwise, don't perform all post-render steps and just
                // do the last template variable injection before passing
                // HTML as string to callback function
                if (!dims){
                    var err = 'Error: lazy loading requested but no aspectRatio provided. ' +
                        'Can\'t determine desired image dimensions.';
                    return lazyCallback(err);
                }
                return lazyCallback(null, template, context);
            } else {
                // now render template
                var markup = self.renderNativeTemplate(template, context);
                // finally, replace placeholder <ins> tag with template and perform post-render
                var parent = self.findTargetElement(false);
                var placeholder = _findChildWithAttribute(parent, self.getPanePlaceholderAttribute(index));
                placeholder.innerHTML = markup;
                _templatePostRender(placeholder, context, dims);
            }
        };

        /**
         * Primary loader function for display placements.
         * Calls self.url, the ad exchange URL, and kicks of rendering & insertion of display
         * ad markup, which is returned by the exchange for the winning bidder.
         *
         * @param lazyCallback
         */
        _Loader.prototype.doDisplayRender = function(lazyCallback){
            var self = this;
            var markup = self.display.markup;
            if (self.lazy){
                return lazyCallback(null, markup);
            } else {
                var el = self.findTargetElement(true);
                el.innerHTML = markup;
                _replaceScripts(el);
            }
        };

        /**
         * Primary loader function for display placements.
         * Calls self.url, the ad exchange URL, and kicks of rendering & insertion of display
         * ad markup, which is returned by the exchange for the winning bidder.
         *
         * @param lazyCallback
         */
        _Loader.prototype.loadDisplay = function(lazyCallback){
            var self = this;
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function(){
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200){
                    self.display.markup = xmlHttp.responseText;
                    self.doDisplayRender(lazyCallback);
                }
            };
            xmlHttp.open("GET", self.url, true); // true for asynchronous
            xmlHttp.send(null);
        };

        /**
         * Calls the url provided by winning bid's `adm` (adserver URL) parameter
         * and kicks of template render. Must be called AFTER exchange has been called,
         * hence the name.
         *
         * @param lazyCallback
         */
        _Loader.prototype.onNativePubLoad = function(lazyCallback){
            var self = this;
            var impUrl = self.native.placementSpecs.adm + '&form-factor=' + self.formFactor;
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    self.native.creativeSpecs = JSON.parse(xmlHttp.responseText);
                    self.doNativeRender(lazyCallback);
                }
            };
            xmlHttp.open("GET", impUrl, true); // true for asynchronous
            xmlHttp.send(null);
        };

        /**
         * Primary loader function for native placement types. Kicks off
         * cascade of AJAX calls, first to exchange, then to adserver,
         * and finally renders templates.
         *
         * @param lazyCallback optional callback function to be invoked when ad is all loaded up. Takes
         *  (err, template, context) as args.
         */
        _Loader.prototype.loadNative = function(lazyCallback){
            var self = this;
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function(){
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    var responseJson = JSON.parse(xmlHttp.responseText);
                    if (self.debug){
                        self.debugData = responseJson.debug;
                    }
                    if (!responseJson.default){
                        self.native.placementSpecs = responseJson;
                        if (self.native.placementSpecs.test){
                            self.native.creativeSpecs = self.native.placementSpecs; // just for testing
                            self.doNativeRender(lazyCallback);
                        } else {
                            self.onNativePubLoad(lazyCallback);
                        }
                    } else {
                        if (lazyCallback){
                            return lazyCallback(null, null, null);
                        }
                    }
                }
            };
            xmlHttp.open("GET", self.url, true); // true for asynchronous
            xmlHttp.send(null);
        };

        /**
         * Renders & inserts the multiPaneNative placement wrapper HTML template
         * into the DOM. Done before individual panes are loaded so that they
         * can be inserted as their ad calls resolve, rather than all at once.
         */
        _Loader.prototype.renderMultiPaneWrapper = function(){
            var self = this;
            var template = self.multiPaneNative.placementSpecs.wrapper.template;
            // create placeholder ins tags
            var panes = '';
            for (var i=0; i<self.multiPaneNative.placementSpecs.count; i++){
                panes += self.getPanePlaceholder(i);
            }
            template = _replaceTemplateVar(template,'panes',panes);
            var el = self.findTargetElement(true);
            el.innerHTML = template;
        };

        /**
         * Calls the urls provided by winning bid's `adms` array of adserver URLs,
         * and kicks off parallel template renders. Must be called AFTER exchange has been called,
         * hence the name.
         *
         * @param lazyCallback
         */
        _Loader.prototype.onMultiPaneNativePubLoad = function(lazyCallback){
            var self = this;
            // write the wrapper template to the DOM
            self.renderMultiPaneWrapper();
            var count = self.multiPaneNative.placementSpecs.count;
            // then loop over ad-server URL's passed back by each winning bid and create Ajax call
            // for each one.
            self.multiPaneNative.creativeSpecs = new Array(count);
            var requests = new Array(count);
            for (var i=0; i<self.multiPaneNative.placementSpecs.count; i++){
                var adm = self.multiPaneNative.placementSpecs.adms[i];
                var impUrl = adm.replace('${FORM-FACTOR}',self.formFactor);
                requests[i] = new XMLHttpRequest();
                var getCallback = function(index){
                    return function(){
                        if (requests[index].readyState == 4 && requests[index].status == 200){
                            self.multiPaneNative.creativeSpecs[index] = JSON.parse(requests[index].responseText);
                            self.doMultiPaneNativeRender(index, lazyCallback);
                        }
                    }
                };
                requests[i].onreadystatechange = getCallback(i);
                requests[i].open("GET", impUrl, true); // true for asynchronous
                requests[i].send(null);
            }
        };

        /**
         * Primary loader function for multiPaneNative placement types. Kicks off
         * cascade of AJAX calls, first to exchange, then to adserver for each creative,
         * and finally renders templates in a loop.
         *
         * @param lazyCallback optional callback function to be invoked when ad is all loaded up. Takes
         *  (err, template, context) as args.
         */
        _Loader.prototype.loadMultiPaneNative = function(lazyCallback){
            var self = this;
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function(){
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    var responseJson = JSON.parse(xmlHttp.responseText);
                    if (self.debug){
                        self.debugData = responseJson.debug;
                    }
                    if (!responseJson.default){
                        self.multiPaneNative.placementSpecs = responseJson;
                        if (!self.multiPaneNative.placementSpecs){
                            if (lazyCallback) return lazyCallback(null, null, null);
                            return;
                        }
                        if (self.multiPaneNative.placementSpecs.test){
                            self.multiPaneNative.creativeSpecs = self.multiPaneNative.placementSpecs.creativeSpecs; // just for testing
                            self.doMultiPaneNativeRender(lazyCallback);
                        } else {
                            self.onMultiPaneNativePubLoad(lazyCallback);
                        }
                    } else {
                        if (lazyCallback){
                            return lazyCallback(null, null, null);
                        }
                    }
                }
            };
            xmlHttp.open("GET", self.url, true); // true for asynchronous
            xmlHttp.send(null);
        };

        /**
         * Initiates the process of submitting a Cliques impression request
         * to the exchange for a placement. Determines what type of placement
         * object was instantiated with (`placement.type`) and calls appropriate
         * loader function for that type.
         *
         * @param lazyCallback optional callback function to be invoked when ad is all loaded up. Takes
         *  (err, template, context) as args. NOTE: For display ads, there is no `template` and `context`, just
         *  markup, so second arg is `markup` and third arg is `null`.
         */
        _Loader.prototype.main = function (lazyCallback){
            var self = this;
            switch (this.type){
                case 'native':
                    self.loadNative(lazyCallback);
                    break;
                case 'multiPaneNative':
                    self.loadMultiPaneNative(lazyCallback);
                    break;
                default:
                    self.loadDisplay(lazyCallback);
            }
        };

        return {
            init: function (options) {
                return new _Loader(options);
            }
        };
    };

    var fString = util.format(f.toString(),exchangeHostname, exchangeSecureHostname, pubPath);
    fString = 'var CLoader = CLoader || (' + fString + '());';
    return fString;
};